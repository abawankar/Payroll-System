@using WebPayroll.Helper
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style type="text/css">
    .form-group {
    margin-bottom: 5px;
}
    .form-control{
        text-align:right;
    }
    input{
    max-width: 100%;
}
</style>
<div class="panel panel-info topmar-10">
    <div class="panel-heading">
        @Html.MyActionLink("<span class='fa fa-dashboard fa-1x'> Dashboard</span>", "Dashboard", "Index", "Home", null, new { @class = "btn btn-info btn-sm" })

        @Html.MyActionLink("<span class='fa fa-files-o fa-1x'> BulkRevision</span>", "BulkRevision", "BulkRevision", "SalaryRevision", null, new { @class = "btn btn-info btn-sm" })

        @Html.DropDownList("branch", new SelectList((ViewBag.branch) as SelectList, "Value", "Text"), "Select Branch", new { @class = "search-box" })
        @Html.DropDownList("EmpId", new SelectList((ViewBag.emp) as SelectList, "Value", "Text"), "Select Employee", new { @class = "search-box" })
    </div>
    <div class="panel-body">
        <div class="panel panel-default no-b-margin" id="empdetails">
            <div class="panel-body">
                <div class="col-md-4 nolrpad">
                    <div class="panel panel-default">
                        <div class="panel-heading text-center">
                        <span class="fa fa-vcard-o"> BASIC DETAILS: <label id="empCode"></label> </span>
                            <span id="load" class="fa fa-spin fa-spinner" style="display:none"></span>
                        </div>
                        <div class="panel-body">
                            <div class="col-sm-3"><img class="profile-img-card" height="100" width="100" src="/Content/themes/base/images/user.jpg" /></div>
                            <div class="col-sm-9">
                                <div class="row pad-5">
                                    <div class="col-sm-2">Name:</div>
                                    <div class="col-sm-10"><label id="empName"></label></div>
                                </div>
                                <div class="row pad-5">
                                    <div class="col-sm-2">DOB:</div>
                                    <div class="col-sm-10"><label id="empDOB"></label></div>
                                </div>
                                <div class="row pad-5">
                                    <div class="col-sm-2">DOJ:</div>
                                    <div class="col-sm-10">
                                        <label id="empDOJ"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="row pad-5">
                                    <div class="col-sm-2">UAN:</div>
                                    <div class="col-sm-4"><label id="uan"></label></div>
                                    <div class="col-sm-2">ESI:</div>
                                    <div class="col-sm-4"><label id="esip"></label></div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-heading text-center"><span class="fa fa-rupee"></span> Annual Package</div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-4 text-primary">Gross</div>
                                <div class="col-md-4 text-primary">CompPFCont</div>
                                <div class="col-md-4 text-primary">Total</div>
                            </div>
                            <div class="row">
                                <div class="col-md-4"><label id="agross"></label></div>
                                <div class="col-md-4"><label id="apf"></label></div>
                                <div class="col-md-4"><label id="ctc"></label></div>
                            </div>
                        </div>

                        <div class="panel-heading text-center"><span class="fa fa-rupee"></span> Revised Annual Package</div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-4 text-primary">Gross</div>
                                <div class="col-md-4 text-primary">CompPFCont</div>
                                <div class="col-md-4 text-primary">Total</div>
                            </div>
                            <div class="row">
                                <div class="col-md-4"><label id="ragross"></label></div>
                                <div class="col-md-4"><label id="rapf"></label></div>
                                <div class="col-md-4"><label id="rctc"></label></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="panel panel-default">
                        <div class="panel-heading text-center"><span class="fa fa-inr"> Current Salary</span></div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-4">Basic</div>
                                <div class="col-sm-8 text-right"><label id="basic"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">HRA</div>
                                <div class="col-sm-8 text-right"><label id="hra"></label></div>
                            </div>

                            <div class="row">
                                <div class="col-sm-4">EduAllowance</div>
                                <div class="col-sm-8 text-right"><label id="EduAllowance"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">TelephoneReimb</div>
                                <div class="col-sm-8 text-right"><label id="TelephoneReimb"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">SatutoryBonus</div>
                                <div class="col-sm-8 text-right"><label id="SatutoryBonus"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">CarRunningReimb</div>
                                <div class="col-sm-8 text-right"><label id="CarRunningReimb"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">OtherAllowance</div>
                                <div class="col-sm-8 text-right"><label id="OtherAllowance"></label></div>
                            </div>




                            <div class="row">
                                <div class="col-sm-4">Conveyance</div>
                                <div class="col-sm-8 text-right"><label id="Conveyance"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">Medical</div>
                                <div class="col-sm-8 text-right"><label id="medical"></label></div>
                            </div>
                            <div class="row text-primary">
                                <div class="col-sm-5">Gross Salary</div>
                                <div class="col-sm-7 text-right"><label id="gross"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">PF</div>
                                <div class="col-sm-8 text-right"><label id="pf"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">VPF</div>
                                <div class="col-sm-8 text-right"><label id="vpf"></label></div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4">ESI</div>
                                <div class="col-sm-8 text-right"><label id="esi"></label></div>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <div class="row text-primary">
                                <div class="col-sm-4">Net Salary</div>
                                <div class="col-sm-8 text-right"><label id="netsalary"></label></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-5 nolrpad">
                    <div class="panel panel-info">
                        <div class="panel-heading text-center"><span class="fa fa-refresh"> Salary Revision</span>
                        @Html.DropDownList("months", new SelectList((ViewBag.Months) as SelectList, "Value", "Text"), "Revision Month", new { @class = "search-box" })
                            <button id="btnSave" type="button" class="btn btn-success btn-sm">
                                <span class="fa fa-save fa-1x"> Save</span>
                                <span id="load1" class="fa fa-spin fa-spinner fa-1x"></span>
                            </button>
                       
                        </div>
                        <div class="panel-body">
                            <div id="reviseSalary" class="container form-horizontal">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-5">Basic</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-Basic" id="re-Basic" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">HRA</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-hra" id="re-hra" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">EduAllowance</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-EduAllowance" id="re-EduAllowance" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">TelephoneReimb</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-TelephoneReimb" id="re-TelephoneReimb" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">SatutoryBonus</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-SatutoryBonus" id="re-SatutoryBonus" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">CarRunningReimb</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-CarRunningReimb" id="re-CarRunningReimb" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">OtherAllowance</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-OtherAllowance" id="re-OtherAllowance" />
                                        </div>
                                    </div>


                                    
                                    <div class="form-group">
                                        <label class="control-label col-md-5">Coneyance</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-coneyance" id="re-coneyance" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">Medical</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-medical" id="re-medical" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">Gross</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-gross" id="re-gross" readonly />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-5">PF</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-pf" id="re-pf" readonly />
                                            <input type="hidden" id="pfCont" name="pfCont" />
                                            <input type="hidden" id="pfcelling" name="pfcelling" />
                                            <input type="hidden" id="salaryid" name="salaryid" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">ESI</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-esi" id="re-esi" readonly />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">IsPF</label>
                                        <div class="col-md-7">
                                            <div class="onoff"><input type="checkbox" value="1" id="IsPF" checked="checked"><label for="IsPF"></label></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">IsPFCelling</label>
                                        <div class="col-md-7">
                                            <div class="onoff"><input type="checkbox" value="1" id="IsPFCelling"><label for="IsPFCelling"></label></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">IsESI</label>
                                        <div class="col-md-7">
                                            <div class="onoff"><input type="checkbox" value="1" id="IsESI"><label for="IsESI"></label></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">Deduction</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="re-ded" id="re-ded" readonly />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-md-5">MonthOfArrear</label>
                                        <div class="col-md-7">
                                            <input class="form-control" type="text" name="ar-month" id="ar-month" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">NetSalary</label>
                                        <div class="col-md-10">
                                            <input style="text-align:center;font-weight:bold;" class="form-control" type="text" name="re-net" id="re-net" readonly />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                     <div class="form-group">
                                    <div class="col-md-offset-2 col-md-10">
                                        
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@*Filtering*@
<script type="text/javascript">
    $(document).ready(function () {
        $('#load').hide();
        $('#load1').hide();
        $("#btnSave").hide();

        $("#months").change(function (e) {
            var m = $("#months").val();
            if (m == "") {
                $("#btnSave").hide();
            }
            else {
                $("#btnSave").show();
            }
        });

        $("#btnSave").click(function () {
            var netsalary = $("#re-net").val();
            if (netsalary == "")
            {
                alert("Please fill revised salary");
                return;
            }

            var objSalary = {};                      //same action as per creating the user  
            objSalary.Id = $("#salaryid").val();
            objSalary.MonthYear = $("#months").val()
            objSalary.EmpId = $("#EmpId").val()
            objSalary.Basic = $("#re-Basic").val();
            objSalary.DA = $("#re-DA").val();
            objSalary.HRA = $("#re-hra").val();

            objSalary.EduAllowance = $("#re-EduAllowance").val();
            objSalary.TelephoneReimb = $("#re-TelephoneReimb").val();
            objSalary.SatutoryBonus = $("#re-SatutoryBonus").val();
            objSalary.CarRunningReimb = $("#re-CarRunningReimb").val();
            objSalary.OtherAllowance = $("#re-OtherAllowance").val();

            objSalary.Conveyance = $("#re-coneyance").val();
            objSalary.Medical = $("#re-medical").val();
            objSalary.PF = $("#re-pf").val();
            objSalary.ESI = $("#re-esi").val();
            objSalary.ArMonth = $("#ar-month").val();

            var IsPFExempted = $("#IsPF").is(":checked");
            var IsPFCelling = $("#IsPFCelling").is(":checked");
            var IsESIExempted = $("#IsESI").is(":checked");
            
            if(IsPFExempted == true)
                objSalary.IsPFExempted = "Y";
            else
                objSalary.IsPFExempted = "N";

            if (IsPFCelling == true)
                objSalary.IsPFCelling = "Y";
            else
                objSalary.IsPFCelling = "N"
            
            if(IsESIExempted == true)
                objSalary.IsESIExempted = "Y"
            else
                objSalary.IsESIExempted = "N"

            $.post("/SalaryMaster/SalaryRevision", { objSalary: objSalary }, function (data) {
                if (data != null) {
                    Details();
                    alert("Salary Revised Successfully");
                }
                else {
                    alert("Error");
                }
            });
        })

        $("#branch").change(function (e) {
            $('#load').show();
            var id = $('#branch').val();
            if (id == null || id == "") {
                id = 0;
            }
            e.preventDefault();
            var emp = $('#EmpId');
            $("#desg").val('');
            $("#dept").val('');
            $.ajax({
                type: 'POST',
                datatype: 'JSON',
                url: "@Url.Action("GetEmpByBran", "Employee",new {area=""},null)",
                data: { branid: id },
                success: function (data) {
                var items = "";
                items += "<option value=\"0\">Select Employee</option>";
                $.each(data.Result, function (i, item) {
                    items = items + "<option value=\"" + item.Id + "\">" + item.Name + "</option>";
                });
                emp.html("");
                emp.html(items);
                $('#load').hide();
            },
            error: function () {
            }
        });
        });

        $("#EmpId").change(function (e) {
            Details();
            $("#re-Basic").focus();
            e.preventDefault();
    });


        function Details() {
            var empid = $("#EmpId").val();
            $('#load').show();

            $.get("/Employee/GetDetailsById", { empid: empid }, function (data) {
                if (data != null) {
                    empid = data.Id;
                    document.getElementById("empCode").innerText = "- " + data.EmpCode;
                    document.getElementById("empName").innerText = data.Name;
                    document.getElementById("empDOB").innerText = JsDate(data.DOB, "dd/mm/yy");
                    document.getElementById("empDOJ").innerText = JsDate(data.DOJ, "dd/mm/yy") + " Total Years: " + data.TotalYears;
                    document.getElementById("uan").innerText = data.UAN
                    document.getElementById("esip").innerText = data.ESIP
                    $("#pfCont").val(data.StatutoryCode.PFCont);
                    $("#pfcelling").val(data.StatutoryCode.PFCelling);

                }
            });

            $.get("/SalaryMaster/GetDetailsById", { empid: empid }, function (data) {
                if (data != null) {
                    $("#salaryid").val(data.Id);
                    document.getElementById("basic").innerText = addCommas(data.Basic);
                    document.getElementById("hra").innerText = addCommas(data.HRA);
                    document.getElementById("Conveyance").innerText = addCommas(data.Conveyance);
                    document.getElementById("medical").innerText = addCommas(data.Medical);

                    document.getElementById("EduAllowance").innerText = addCommas(data.EduAllowance);
                    document.getElementById("TelephoneReimb").innerText = addCommas(data.TelephoneReimb);
                    document.getElementById("SatutoryBonus").innerText = addCommas(data.SatutoryBonus);
                    document.getElementById("CarRunningReimb").innerText = addCommas(data.CarRunningReimb);
                    document.getElementById("OtherAllowance").innerText = addCommas(data.OtherAllowance);


                    document.getElementById("gross").innerText = addCommas(data.GrossSalary);
                    document.getElementById("agross").innerText = addCommas(data.GrossSalary * 12);
                    document.getElementById("apf").innerText = addCommas(data.PF * 12);
                    document.getElementById("ctc").innerText = addCommas((data.GrossSalary * 12) + (data.PF * 12));

                    document.getElementById("pf").innerText = "- " + addCommas(data.PF);
                    document.getElementById("vpf").innerText = "- " + addCommas(data.VPF);
                    document.getElementById("esi").innerText = "- " + addCommas(data.ESI);

                    document.getElementById("netsalary").innerText = addCommas(data.NetSalary);
                    $('#load').hide();

                    $("#re-Basic").val(0);
                    $("#re-hra").val(0);

                    $("#re-EduAllowance").val(0);
                    $("#re-TelephoneReimb").val(0);
                    $("#re-SatutoryBonus").val(0);
                    $("#re-CarRunningReimb").val(0);
                    $("#re-OtherAllowance").val(0);

                    $("#re-coneyance").val(0);
                    $("#re-medical").val(0);
                    $("#re-pf").val(0);
                    $("#re-esi").val(0);
                    $("#re-gross").val("");
                    $("#re-ded").val("");
                    $("#re-net").val("");
                }
            });

        }
    });
</script>

<script type="text/javascript">

    

    $("#re-Basic").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-pf").val(CalculatePF);
        $("#re-ded").val(totalDedn);
        $("#re-net").val(NetSalary);
    });
    $("#re-EduAllowance").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-TelephoneReimb").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-SatutoryBonus").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-CarRunningReimb").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-OtherAllowance").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-hra").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-coneyance").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $("#re-medical").change(function (e) {
        $("#re-gross").val(GrossSalary);
        $("#re-net").val(NetSalary);
    });
    $('#IsPF').change(function () {
        $("#re-pf").val(CalculatePF);
        $("#re-net").val(NetSalary);
    });
    $('#re-gross').change(function () {
        $("#re-ded").val(totalDedn);
        $("#re-net").val(NetSalary);
    });

    $('#IsPFCelling').change(function () {
        $("#re-pf").val(CalculatePF);
        $("#re-ded").val(totalDedn);
        $("#re-net").val(NetSalary);
    });
    $('#IsESI').change(function () {
        $("#re-esi").val(CalculateESI);
        $("#re-ded").val(totalDedn);
        $("#re-net").val(NetSalary);
    });
    function GrossSalary() {
        var Basic = parseFloat($("#re-Basic").val());
        var HRA = parseFloat($("#re-hra").val());
        var Conveyance = parseFloat($("#re-coneyance").val());
        var Medical = parseFloat($("#re-medical").val());

        var EduAllowance = parseFloat($("#re-EduAllowance").val());
        var TelephoneReimb = parseFloat($("#re-TelephoneReimb").val());
        var SatutoryBonus = parseFloat($("#re-SatutoryBonus").val());
        var CarRunningReimb = parseFloat($("#re-CarRunningReimb").val());
        var OtherAllowance = parseFloat($("#re-OtherAllowance").val());


        return Basic + HRA + Conveyance + Medical + EduAllowance + TelephoneReimb + SatutoryBonus + CarRunningReimb + OtherAllowance;
    }

    function CalculatePF() {
        var Basic = parseFloat($("#re-Basic").val());
        var IsPFExempted = $("#IsPF").is(":checked");
        var IsPFCelling = $("#IsPFCelling").is(":checked");
        var pfcont = 12;//parseFloat($("#pfCont").val());
        var pfcelling = 15000;//parseFloat($("#pfcelling").val());
        if (IsPFExempted == true) {
            if (IsPFCelling == true)
            {
                if (Basic >= pfcelling)
                    return Math.round((pfcelling * pfcont) / 100);
                else
                    return Math.round((Basic * pfcont) / 100);
            }
            else
            {
                return Math.round((Basic * pfcont) / 100);
            }
            
        }
        else
            return 0;
    }

    function CalculateESI() {
        var gross = GrossSalary();
        var IsESIExempted = $("#IsESI").is(":checked");
        if (IsESIExempted == true) {
            return Math.ceil((gross * 1.75) / 100);
        }
        else
            return 0;
    }

    function totalDedn()
    {
        var pf = CalculatePF();
        var esi = CalculateESI();
        return pf + esi;
    }

    function NetSalary() {
        var gross = GrossSalary();
        var dedn = totalDedn();
        var apf = CalculatePF() * 12;
        var agross = gross * 12;
        
        document.getElementById("ragross").innerText = addCommas(agross);
        document.getElementById("rapf").innerText = addCommas(apf);
        document.getElementById("rctc").innerText = addCommas(agross + apf);
        
        return gross -dedn
    }
</script>




